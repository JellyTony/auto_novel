我要做的是**可复用、可自动化、质量稳定的长篇小说生成流水线**。下面把一套“拿去就能用”的详细策略、所有关键提示词（中文）、实现要点、以及可运行的示例模板都一次性给我：从世界观、大纲、逐章生成、上下文管理、润色到质量检测与导出。按着做，我能自动产出几万字且质量可控的小说。

---

# 核心思路（一句话）

把**写作**拆成**结构化的子任务**（世界观 → 角色卡 → 章节大纲 → 逐章生成 → 校对润色 → 一致性检查 → 输出），用 LLM 做“写手 + 编辑 + 校验器”，并用**摘要/检索/嵌入（RAG）**保证跨章连贯性。

---

# 总体流水线（步骤概览）

1. 世界观设定（Worldbuilding）
2. 人物卡（Character Cards）
3. 全书章节大纲（30–80 章）
4. 逐章扩写（分批、带前情摘要）
5. 每章自动润色/校对/矛盾检查
6. 跨章一致性校验（时间线、人物关系、道具、关键物）
7. 合并输出（TXT/EPUB），拆分用于短视频的分镜脚本
8. （可选）用 Embeddings + FAISS 做上下文检索，防止遗忘

---

# 参数建议（模型调用）

* temperature（创造性）：0.2–0.45（连贯）或 0.6–0.9（想要更“奇想/反转”）
* top_p：0.8–0.95
* max_tokens（单次输出）：章节生成建议 1500–3000 token（看模型上下文限制）
* frequency_penalty：0–0.2（避免重复）
* presence_penalty：0–0.1
* 多次尝试取最佳：同一 prompt 多跑 2 次，保留好版本

---

# 一：世界观设定 Prompt（模板）

```
你是一个经验丰富的小说设定师。请根据下列要点完整输出世界观设定，风格简洁明确，便于后续写作调用：
- 体裁：{体裁，比如“现代都市/悬疑/玄幻/科幻/古代言情”}
- 时代与地点：{年代、城市或国度}
- 基本规则/设定：{如超能力规则、社会结构、特殊物品、技术背景}
- 调性与节奏：{偏温情、冷峻、快节奏、慢热}
- 目标读者：{青年/女性向/男性向/泛读者}
- 关键主题（3条）：{如“复仇、救赎、成长”}
请返回 JSON 格式，包括 "title", "synopsis"（200 字以内）, "key_rules"（要点列表）, "tone_examples"（2-3 句示例风格片段）。
```

**示例（填充后）**会输出可直接粘入后续 prompt 的「世界观摘要」。

---

# 二：人物卡（Character Cards）——必须结构化

每个主要角色用结构化卡保存，示例 schema：

```json
{
  "name": "李明",
  "role": "男主",
  "age": 28,
  "appearance": "高个、深目、总戴一副黑框眼镜",
  "background": "程序员出身，曾经创业失败",
  "motivation": "想证明自己不是失败者",
  "flaws": "固执、容易自责",
  "speech_tone": "少话，话语简洁有力",
  "secrets": ["曾经抄袭别人的项目"],
  "relationship_map": {"女主":"青梅竹马，后来误会"}
}
```

在每次生成章节时，把 relevant 人物卡直接放入 prompt。

---

# 三：章节大纲 Prompt（模板）

```
你是资深小说编剧，请基于以下世界观与人物卡，给出整本书的章节大纲（共 N 章），每章 1-3 句的概要，明确本章的“剧情目标”“小冲突/反转点”“关键道具/线索（如果有）”。输出 JSON 数组，字段：chapter_index, title, summary, goal, twist_hint, important_items。
世界观摘要：{插入世界观}
主要人物卡（JSON 列表）：{插入人物卡}
风格说明：{插入短风格示例}
```

**产出**：适合直接导入为章节任务队列。

---

# 四：逐章生成 Prompt（最关键，须带“前情摘要”）

**原则**：每次生成一章（或分块生成一章），给模型**本章目标 + 前情摘要（300–600字） + 人物卡 + 写作风格示例 + 明确的结构要求**。

**模板**：

```
你是专业小说作者。请写“第 {i} 章”，要求如下：
1) 前情摘要（上文）：{前情摘要，300-600字}
2) 本章目标：{本章剧情要达到的目的，例如“女主发现男主隐瞒的秘密，引发冲突”}
3) 角色限定与说话风格：{列主要出场人物，及其 speech_tone }
4) 结构要求：
   - 字数目标：{例如 1800-2500 字}
   - 开头（第一段）要用一句引人注意的钩子（不超过20字）
   - 中段需包含 1 个对话冲突和 2 个心理描写镜头
   - 结尾留一个小反转或悬念
5) 描写约束：
   - 以镜头化写作（动作、视觉、听觉、嗅觉）
   - 尽量用具体的动词和细节（避免“他很伤心”）
6) 风格示例：{贴 1-2 段你希望模仿的风格短文}
7) 禁止：不要泄露重大伏笔（除非明确需要），不要突然引入未设定的超自然规则
8) 输出格式：只返回正文（不要返回备注或 JSON）
现在开始写作：
```

**要点**：把“前情摘要”用你维护的压缩版本（见下一节）喂模型，避免放入全部历史文本占用 token。

---

# 五：压缩前情 / 摘要维护（必做）

模型容易“健忘”——每生成新章前，把之前若干章压缩成 200–600 字的剧情摘要（可由模型自动生成）。用两个 prompt：

1. `CompressSummary`：把 N 章文本压缩为 X 字剧情要点（保持人物关系与关键道具）
2. 当出现重要事实（密钥、时间线、秘密）时，把这些以结构化形式写入「世界状态表」并保存到数据库或本地 JSON。

**Compress 示例 prompt**：

```
请把以下文本（第1-6章）浓缩成 300 字剧情摘要，保留：主线冲突、每个主要角色的现状、已知的关键线索/道具、时间节点。输出 JSON：{"summary":"...","character_states":[...],"key_items":[...]}
```

---

# 六：润色与一致性检查（自动化质量提升）

每章生成后自动运行两个步骤：

A. **润色（Polish）**：提升语言、连贯性、修饰重复句、中文语感校正

```
你是资深中文编辑。请对以下章节进行润色：使语句更通顺、修复重复表达、加强意象、保持角色口吻一致；不要改变主要情节或人物决定。输出润色后文本。
```

B. **质量审查（Critique）**：找出矛盾、信息缺失、人物说行不一处并给出修复建议（并按优先级标注）

```
作为小说编辑，请审查下文，列出：1) 逻辑矛盾（若干条） 2) 人物不一致 3) 节奏问题 4) 可增强之处（列出具体改写建议），最后给出修订后的片段示例（50-150字）。
```

把建议自动应用或人工审核后再写下一章。

---

# 七：跨章一致性（Timeline / Props / Secrets）

维护三个表（JSON）：

* timeline.json：关键时间点与事件
* props.json：关键物品描述与出现位置
* secrets.json：每个秘密的拥有者、知道的人和泄露时间

每生成新章时，先用检索（embeddings or simple keyword search）找出与本章相关的 timeline/props/secrets 条目，传入 prompt，提示“不得与下列时间线冲突”。

---

# 八：使用 Embeddings 做检索（推荐，用于长书）

思路：每章的「压缩摘要」+「人物卡」做 embedding 存进向量库（FAISS/Weaviate/Chroma）。下次生成前检索 top-k 相关内容作为上下文，这比把全部历史放进 prompt 更高效。

示例伪代码（Python 风格）：

```python
# 伪代码，替换为你使用的 embedding provider
embed = get_embedding(chapter_summary_text)
faiss.add(embed, metadata={'chapter':i})
# 生成时
related = faiss.search(query_embed, top_k=6)  # 返回相关章节摘要
context = "\n".join([r['summary'] for r in related])
```

---

# 九：样例完整工作流（从 0 到 1 的最少步骤）

1. 写 worldbuilding prompt，生成世界观 JSON。
2. 用人物卡模板写 6–10 个核心人物卡。
3. 用章节大纲 prompt 生成 30–50 章概要，导出为 chapters.json。
4. 执行循环（i=1..N）：

   * 从 FAISS 或 chapters.json 获取前情摘要（或用 CompressSummary 生成）；
   * 调用 Chapter Generation Prompt 生成第 i 章原稿（save raw）；
   * 调用 Polish Prompt 得到润色稿（save polished）；
   * 调用 Critique Prompt 得到修改建议（apply if自动化规则满足或人工复核）；
   * 生成本章 summary，写入向量库；更新 timeline/props/secrets（如果有新增）。
5. 最后执行全书一致性检查：把所有 polished 章节给 Critique，总结并修复全局问题；然后导出为 TXT/EPUB。

---

# 十：防止“跑题/崩坏”的实践技巧（实战必做）

1. **短上下文窗口+摘要**：不要一次把整本书喂模型；用压缩摘要和检索上下文。
2. **角色卡每次必须送入**：确保人物性格不变。
3. **用“chapter goal”约束输出**：把每章的任务写得很明确。
4. **频繁做“压缩+校验”**：每 3–5 章做一次全局压缩并让模型检查逻辑。
5. **把反转点写在大纲并在相应章节前再次提醒模型**。
6. **对重要事实做断言检查**：模型输出后运行自动脚本确认关键信息仍和状态表一致（例如：某角色是否死、某物是否存在）。
7. **版本控制**：每次生成都保存 raw + polished + summary，便于回滚。

---

# 十一：直接可用的关键 Prompt 模板合集（中文）

> 把下面直接复制粘贴到你的脚本里，用 `str.format(...)` 替换 `{}` 部分。

**1) 生成世界观**

```
你是资深小说设定师。请用不超过 300 字写出本书的世界观 JSON：
{"title":"","synopsis":"","setting":"", "rules":[], "tone_examples": ["",""]}
体裁：{genre}，目标读者：{audience}，基调：{tone}
```

**2) 生成人物卡（示例提示）**

```
请根据世界观为书中主要人物生成 JSON 人物卡（每人 8-12 条要点）：name, role, age, appearance, background, motivation, flaws, speech_tone, secrets, relationship_map。
主要人物清单：{comma separated names}
```

**3) 章节大纲**
（参见第三节模板）

**4) 逐章生成（核心）**
（参见第四节模板；这里给一个具体执行示例）

```
你是专业小说作者。写第 {i} 章正文：
- 前情摘要：{prev_summary}
- 主要出场人物：{characters_json}
- 本章目标：{goal}
- 字数：{min}-{max} 字
- 要求：开头一句钩子；中段有强冲突；结尾保留小悬念；镜头化写法；避免 info-dump。
只返回正文文本，不要额外解释。
```

**5) 缩写摘要（Compress）**

```
请把下面的第1到第{n}章原文压缩成不超过 {L} 字的剧情总结，输出 JSON：{"summary":"...","character_states":[...],"key_items":[...]}
```

**6) 润色（Polish）**

```
你是中文小说润色专家，请把下面章节润色：提升语言、消除重复、加强场景细节、保持人物口吻。不要改变主要情节和人物决定。输出润色后完整文本。
```

**7) 校验（Critique）**

```
作为资深小说编辑，请审查下文并输出：
1) 逻辑矛盾（按优先级）
2) 人物性格冲突/不一致的地方
3) 节奏与情绪建议
4) 需要修正的具体句子（给出修改示例）
输入文本：{chapter_text}
```

**8) 生成短视频分镜（把章节拆成 8-12 屏）**

```
请把下面章节拆分为 8-12 个屏（每屏 1-2 句），并为每屏输出：screen_index, text, suggested_bgm_tag, suggested_image_tag, tts_voice (male/female), notes。目标：适配抖音竖屏朗读。
```

---

# 十二：示例：一轮完整的 Chapter 生成（中文示例）

（这是你可以直接复制到脚本的 prompt）

```
系统：你是经验丰富的中文小说家，擅长情感与反转类短篇长篇小说，语言简练、有画面感。
用户：前情摘要：{前情摘要：300字}
本章目标：{本章目标：例如“男主发现女主的日记，误会加剧”}
主要人物：{李明（男主，性格...）；张雨（女主...）}
写作要求：字数 1800-2200 字；开头一句钩子；中段至少一段 8 行对话；末尾埋伏笔；镜头化（动作+心理+环境描写）；语言避免口语化词“就是”“然后”过多。
请直接输出正文。
```

---

# 十三：可运行的 Python 编排范例（伪代码 + 可替换真实 openai 调用）

下面是一个**最小可运行的 orchestrator** 伪代码，替换 `call_model()` 为你所用 API 的调用函数。

```python
import json, os, time
# 假设你已经实现 call_model(messages, max_tokens, temperature)
# 以及 get_embedding(text), faiss_add(embed,meta), faiss_search(embed,k)

def generate_world(genre, audience, tone):
    prompt = WORLD_PROMPT.format(genre=genre, audience=audience, tone=tone)
    return call_model([{"role":"user","content":prompt}], max_tokens=600, temperature=0.2)

def gen_chapter(ch_index, prev_summary, chapter_goal, chars_json):
    prompt = CHAPTER_PROMPT.format(i=ch_index, prev_summary=prev_summary, goal=chapter_goal, characters_json=json.dumps(chars_json), min=1800, max=2200)
    raw = call_model([{"role":"user","content":prompt}], max_tokens=2500, temperature=0.35)
    return raw

# 主流程
world = generate_world("现代都市","青年","略带反转的现实主义")
# 生成人物卡、章节大纲（略）
for i,chapter in enumerate(chapters):
    prev_summary = get_prev_summary(i)  # 从 faiss 或本地 summary.json
    raw = gen_chapter(i, prev_summary, chapter['goal'], main_char_cards)
    polished = call_model([{"role":"user","content":POLISH_PROMPT.format(chapter_text=raw)}], max_tokens=1500, temperature=0.2)
    critique = call_model([{"role":"user","content":CRITIQUE_PROMPT.format(chapter_text=polished)}], max_tokens=400, temperature=0)
    save_files(i, raw, polished, critique)
    # 生成 summary 并存入向量库
    summary = call_model([{"role":"user","content":COMPRESS_PROMPT.format(text=polished, L=300)}], max_tokens=400, temperature=0)
    embed = get_embedding(summary)
    faiss_add(embed, {'chapter':i, 'summary':summary})
```

> 把 `call_model` 换成 `openai.ChatCompletion.create` 或你喜欢的 SDK；`get_embedding` 换成你的 embedding API。

---

# 十四：自动化质量检测（脚本化提示）

* **重复度检测**：计算章节间重复率（简单字符串相似度或句向量相似度），若 > 0.45 发出警告。
* **人物说话风格检测**：抽取长台词，要求符合角色 speech_tone，否则标记修改。
* **时间线冲突检测**：把 timeline.json 中的事件做一致性检测（事件发生顺序是否被后文打断）。

这些检测可以用小脚本结合 embedding 或编辑距离实现。

---

# 十五：如何保证“文学性/画面感/避免流水账”——实用写作提示（写 prompt 用）

在“逐章生成 prompt”中加入这些具体子提示（复制即可）：

* “请通过具体动作、感官描写和细节来表现人物内心（示例：他手指不停在杯边画圈 → 表示焦虑），避免使用抽象词‘伤心’或‘难过’。”
* “对话要有节奏：用简短句子表现紧张，用长句表现思考。确保每次对话前写出说话者的肢体动作。”
* “在全书中至少出现 5 个能代表主题的意象（例：断了的怀表、雨伞、血红的信封），请在大纲中标注。”

---

# 十六：把小说拆成适合抖音的短视频（自动拆分）

每章生成后，用“短视频分镜 prompt”把章节拆为 8–12 屏，每屏 15–30 字，生成 TTS 文本、配图标签与建议 BGM。直接把输出格式化成 CSV，供自动化视频合成脚本读取（moviepy/ffmpeg + TTS）。

---

# 十七：常见问题与对策

* **问题**：模型把已死角色写活了／忘记伏笔。
  **对策**：timeline/secrets 明确写入并在 prompt 中强制 `DO NOT CHANGE`。遇到冲突自动回滚到上一个稳定版本。
* **问题**：写出来很平淡缺乏情绪。
  **对策**：把temperature调高 0.6–0.9 并用“情感映射”提示（例如“把愤怒写成快节奏短句”）。
* **问题**：成本太高（token 多）。
  **对策**：压缩前情摘要长度，使用 embeddings 检索替代直接拼接历史，或降低 max_tokens，把章节分成两段单独生成合并。

---

# 十八：直接可复制的「第 1 章」完整示例 Prompt（一键用）

```
系统：你是小说家，语言有画面感，擅长铺垫与反转。
用户：
前情（世界观 & 人物简述）：
- 体裁：现代都市情感反转
- 世界观：城市高速发展背景，社交媒体放大私人生活
- 男主：李明，28岁，程序员，性格固执；女主：张雨，27岁，编辑，性格谨慎
本章目标：男主发现女主的日记，误会升级
前情摘要：{将第0章或序章压缩后放这里，约 200-400 字}
写作要求：
- 字数 1800-2000 字
- 开头要用一句钩子（<=20 字）
- 中段必须出现至少 1 场对话冲突（不少于 8 行）
- 结尾留小悬念（适合短视频断更）
- 镜头化写法：动作、视觉、听觉、嗅觉都要写
- 语体示例（仿照）：“窗外雨一直下，像有人在清算每一件无关紧要的小事。”
输出正文，不要任何多余说明。
```

---

# 十九：版权与合规提醒

* 避免直接抄袭知名作品或逐字复刻已出版小说；大纲、情节可受启发但成品要原创。
* 遵守平台（抖音/小说平台）对内容的审查规则（未成年人、极端暴力、色情等）。

---

# 二十：把它变成“工厂”——工程化建议

* 把每个步骤做成独立服务：`world-service`、`outline-service`、`generator-service`、`polish-service`、`vector-service`。用队列（RabbitMQ/Redis Queue）调度任务。
* 每次生成都写入版本库（git-like），方便回滚与 A/B 测试风格。
* 定期抓取表现数据（播放量/完播率/评论），把高表现内容作为“风格示例”喂模型做 fine-tune-like prompt。

---

将上面所有模板、提示词、脚本骨架整合后，我就有了一套“可复制、可扩展”的长篇小说自动化生成流水线：从 0 起步到几万字只需要按章节循环执行并做必要的人为把关（1~2 轮人工编辑能极大提升质量）。

